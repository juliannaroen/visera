name: Test Backend

on:
  push:
    branches:
      - main
    paths:
      - "backend/**"
      - ".github/workflows/test-backend.yml"
  pull_request:
    branches:
      - main
    paths:
      - "backend/**"
      - ".github/workflows/test-backend.yml"
  workflow_dispatch: # Allows manual triggering

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history for comparison

      - name: Check if backend files changed
        id: check-backend
        run: |
          set -e
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Get list of changed files
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # For PRs, compare against the base branch
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA)
          else
            # For pushes, compare against previous commit
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          fi

          # Check if any backend files or workflow file were changed
          if echo "$CHANGED_FILES" | grep -q "^backend/" || echo "$CHANGED_FILES" | grep -q "^\.github/workflows/test-backend\.yml$"; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Backend files or workflow file changed, running tests"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No backend files or workflow file changed, skipping tests"
          fi

      - name: Set up Python
        if: steps.check-backend.outputs.changed == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install PDM
        if: steps.check-backend.outputs.changed == 'true'
        uses: pdm-project/setup-pdm@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        if: steps.check-backend.outputs.changed == 'true'
        working-directory: ./backend
        run: |
          set -e
          pdm install -G test

      - name: Run tests with code coverage
        if: steps.check-backend.outputs.changed == 'true' && success()
        working-directory: ./backend
        env:
          # Auth Configuration
          AUTH_COOKIE_NAME: test.sid
          AUTH_COOKIE_MAX_AGE: 2592000
          JWT_SECRET_KEY: test-secret-key-for-testing-only
          JWT_EXPIRE_MINUTES: 1440
          # Database Configuration (tests use in-memory SQLite, but config requires this)
          DATABASE_URL: "sqlite:///:memory:"
          # Email Configuration (dummy values for tests)
          SMTP_HOST: smtp.example.com
          SMTP_PORT: 587
          SMTP_USER: testuser
          SMTP_PASSWORD: testpass
          SMTP_FROM_EMAIL: test@example.com
          FRONTEND_URL: http://localhost:3000
          # CORS Configuration
          ALLOWED_ORIGINS: http://localhost:3000
          # App Configuration
          ENVIRONMENT: test
        run: |
          set -e
          pdm run test-cov
        continue-on-error: true
