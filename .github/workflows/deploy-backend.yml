name: Deploy Backend

on:
  push:
    branches:
      - main
    paths:
      - ".github/workflows/deploy-backend.yml"
  workflow_run:
    workflows: ["Test Backend"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch: # Allows manual triggering

env:
  PROJECT_ID: visera-479600
  SERVICE_NAME: visera-backend
  REGION: us-central1

concurrency:
  group: deployment
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Only deploy if tests passed (when triggered by workflow_run) or when workflow file is updated
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'push' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch || github.ref }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install migration dependencies
        working-directory: ./backend
        run: |
          set -e
          pip install --quiet alembic sqlalchemy psycopg2-binary python-dotenv

      - name: Run database migrations
        working-directory: ./backend
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          set -e
          echo "ğŸ”„ Running database migrations..."
          python -m alembic upgrade head
          echo "âœ… Migrations completed successfully!"

      - name: Deploy to Cloud Run
        if: success()
        run: |
          set -e
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --source ./backend \
            --region ${{ env.REGION }} \
            --allow-unauthenticated \
            --set-env-vars "DATABASE_URL=${{ secrets.DATABASE_URL }},VERCEL_PROD_URL=${{ secrets.VERCEL_PROD_URL }},JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }},SMTP_HOST=smtp.sendgrid.net,SMTP_PORT=587,SMTP_USER=apikey,SMTP_FROM_EMAIL=${{ secrets.SMTP_FROM_EMAIL }},FRONTEND_URL=${{ secrets.FRONTEND_URL }}" \
            --update-secrets SMTP_PASSWORD=sendgrid-api-key:1 \
            --port 8001 \
            --project ${{ env.PROJECT_ID }}

      - name: Get Service URL
        if: success()
        id: get-url
        run: |
          set -e
          URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region ${{ env.REGION }} \
            --format 'value(status.url)' \
            --project ${{ env.PROJECT_ID }})
          echo "service_url=$URL" >> $GITHUB_OUTPUT

      - name: Output Service URL
        if: success()
        run: |
          set -e
          echo "âœ… Backend deployed successfully!"
          echo "ğŸŒ Service URL: ${{ steps.get-url.outputs.service_url }}"
